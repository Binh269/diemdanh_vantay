import base64
import ctypes
from ctypes import wintypes
import datetime
import hashlib
from mailbox import mbox
import os
import random
import shutil
import sqlite3
import string
import tempfile
import time
from tkinter import Image
import urllib.request as url_request
from django.conf import settings
from django.http import HttpResponse, HttpResponseServerError, JsonResponse
from django.shortcuts import render, redirect
from django.views import View
import xlwt
import xlrd
from openpyxl import load_workbook
from Show.traning import train_new_student
from .models import Model_Phong
from django.contrib import messages
import json
import numpy as np
from django.core.files.base import ContentFile
import torch
import cv2
from facenet_pytorch import InceptionResnetV1, MTCNN
from torchvision import transforms
from django.views.decorators.csrf import csrf_exempt
from PIL import Image
from scipy.spatial.distance import cosine
import pyodbc
from datetime import datetime, timedelta
from unidecode import unidecode
from collections import Counter
from django.contrib.auth.models import User
from django.contrib.auth import login, authenticate
from django.contrib.auth import logout
from django.contrib.auth.decorators import login_required
from django.contrib.sessions.models import Session
import openpyxl
from django.core.files.storage import default_storage
from collections import Counter, defaultdict
from django.utils import timezone
import pandas as pd
from pyfingerprint.pyfingerprint import PyFingerprint
import logging
from django.contrib.auth.decorators import user_passes_test
from django.http import HttpResponseForbidden
from django.contrib.auth.hashers import make_password
from django.contrib.auth.hashers import check_password
from django.views.decorators.csrf import ensure_csrf_cookie
from django.contrib.auth.models import AbstractUser
from django.db import models
import mediapipe as mp

def is_superuser_sql(user_id):
    conn = connect_to_db()
    cursor = conn.cursor()
    try:
        cursor.execute("SELECT is_superuser FROM auth_user WHERE id = ?", (user_id,))
        result = cursor.fetchone()
        if result and result[0] >= 1: 
            return True
        return False
    except Exception as e:
        print(f"L·ªói khi ki·ªÉm tra is_superuser: {e}")
        return False
    finally:
        cursor.close()
        conn.close()

def superuser(user_id):
    conn = connect_to_db()
    cursor = conn.cursor()
    try:
        cursor.execute("SELECT is_superuser FROM auth_user WHERE id = ?", (user_id,))
        result = cursor.fetchone()
        if result and result[0] == 2: 
            return True
        return False
    except Exception as e:
        print(f"L·ªói khi ki·ªÉm tra is_superuser: {e}")
        return False
    finally:
        cursor.close()
        conn.close()

def admin_required_sql(view_func):
    @login_required(login_url="login")
    def wrapper(request, *args, **kwargs):
        if not is_superuser_sql(request.user.id):
            return HttpResponseForbidden("B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p!")
        return view_func(request, *args, **kwargs)
    return wrapper

@login_required(login_url="login")  
def index(request):
    return render(request, "index.html")

@login_required(login_url="login")
def Lich(request):
    if not is_superuser_sql(request.user.id):
        return render(request, "lich.html", {'restrict_class_selection': True})
    return render(request, "lich.html", {'restrict_class_selection': False})

@login_required(login_url="login")
def ql_sv(request):
    return render(request, "quanly.html")

@login_required(login_url="login")
@admin_required_sql
def Diemdanh(request):
    return render(request, 'diemdanh.html')

@login_required(login_url="login")
def thongke_view(request):
    return render(request, "thongke.html")

@login_required(login_url="login")
@admin_required_sql
def setting(request):
    return render(request, "setting.html")

def connect_to_db():
    return sqlite3.connect("db.sqlite3")


# device = torch.device("cuda")
device = torch.device("cuda" if torch.cuda.is_available() else "cpu")
model = InceptionResnetV1(pretrained='vggface2').eval().to(device)
mp_face_detection = mp.solutions.face_detection
face_detection = mp_face_detection.FaceDetection(
    model_selection=0, 
    min_detection_confidence=0.5  
)
transform = transforms.Compose([
    transforms.ToPILImage(),
    transforms.Resize((128, 128)),
    transforms.ToTensor(),
    transforms.Normalize(mean=[0.5, 0.5, 0.5], std=[0.5, 0.5, 0.5])
])

def embedding_to_string(embedding):
    return json.dumps(embedding.tolist())

def string_to_embedding(embedding_str):
    if embedding_str is None:
        raise ValueError("Embedding kh√¥ng ƒë∆∞·ª£c ph√©p l√† None")
    return np.array(json.loads(embedding_str))

def preprocess_frame(frame):
    max_width = 320
    h, w = frame.shape[:2]
    if w > max_width:
        scale = max_width / w
        new_h, new_w = int(h * scale), int(w * scale)
        frame = cv2.resize(frame, (new_w, new_h), interpolation=cv2.INTER_AREA)
    return frame
embedding_cache = {}

def detect_face(frame, lophp, request):
    frame = preprocess_frame(frame)
    
    frame_rgb = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)
    
    results = face_detection.process(frame_rgb)
    detected_labels = []

    if not results.detections:  
        return detected_labels

    h, w = frame.shape[:2]
    orig_h, orig_w = frame.shape[:2]
    scale_x, scale_y = orig_w / w, orig_h / h

    if lophp not in embedding_cache:
        conn = connect_to_db()
        cursor = conn.cursor()
        cursor.execute("""
            SELECT DISTINCT thongtin.mssv, thongtin.khuonmat 
            FROM thongtin 
            INNER JOIN dkmh ON dkmh.mssv = thongtin.mssv 
            WHERE dkmh.lophp = ? AND thongtin.khuonmat IS NOT NULL
        """, (lophp,))
        embeddings_data = cursor.fetchall()
        conn.close()

        embedding_cache[lophp] = {
            'embeddings': np.array([string_to_embedding(row[1]) for row in embeddings_data if row[1] is not None]),
            'labels': [row[0] for row in embeddings_data if row[1] is not None]
        }

    dataset_embeddings = embedding_cache[lophp]['embeddings']
    dataset_labels = embedding_cache[lophp]['labels']

    if not dataset_embeddings.size:
        return detected_labels

    settings = get_user_settings(request, as_dict=True)
    MIN_AREA_THRESHOLD = settings['kichthuoc'] *(0.5)
    MIN_DISTANCE_THRESHOLD = settings['nguong']

    for detection in results.detections:
        bbox = detection.location_data.relative_bounding_box
        x1 = int(bbox.xmin * w * scale_x)
        y1 = int(bbox.ymin * h * scale_y)
        x2 = int((bbox.xmin + bbox.width) * w * scale_x)
        y2 = int((bbox.ymin + bbox.height) * h * scale_y)
        
        width = x2 - x1
        height = y2 - y1
        area = width * height

        if area < MIN_AREA_THRESHOLD:
            continue

        face = frame[int(y1 / scale_y):int(y2 / scale_y), int(x1 / scale_x):int(x2 / scale_x)]
        if face.size == 0:
            continue

        face_tensor = transform(face).unsqueeze(0).to(device)
        face_embedding = model(face_tensor).detach().cpu().numpy().flatten()

        distances = 1 - np.dot(dataset_embeddings, face_embedding) / (
            np.linalg.norm(dataset_embeddings, axis=1) * np.linalg.norm(face_embedding)
        )
        min_distance_idx = np.argmin(distances)
        min_distance = distances[min_distance_idx]
        label = dataset_labels[min_distance_idx] if min_distance < MIN_DISTANCE_THRESHOLD else "Kh√¥ng bi·∫øt"

        detected_labels.append({
            'label': label,
            'box': [int(x1), int(y1), int(x2), int(y2)]
        })

    return detected_labels


@login_required(login_url="login")
def get_user_settings(request, as_dict=False):
    conn = connect_to_db()
    cursor = conn.cursor()
    try:
        magv = str(request.user.id)
        cursor.execute("SELECT kichthuoc, nguong FROM setting WHERE magv = ?", (magv,))
        result = cursor.fetchone()

        if result:
            kichthuoc = int(result[0]) if result[0] is not None else 12000
            nguong = float(result[1]) if result[1] is not None else 0.2
            data = {'kichthuoc': kichthuoc, 'nguong': nguong}
        else:
            data = {'kichthuoc': 12000, 'nguong': 0.2}

        print(f"DEBUG: User settings for magv {magv}: {data}")
        if as_dict:
            return data
        return JsonResponse(data)

    except Exception as e:
        print(f"L·ªói khi l·∫•y c√†i ƒë·∫∑t ng∆∞·ªùi d√πng: {e}")
        data = {'kichthuoc': 12000, 'nguong': 0.2}
        if as_dict:
            return data
        return JsonResponse({'status': 'fail', 'message': f'L·ªói: {str(e)}'}, status=500)

    finally:
        cursor.close()
        conn.close()

@login_required(login_url="login")
@admin_required_sql
def save_settings(request):
    if request.method != "POST":
        return JsonResponse({'status': 'fail', 'message': 'Ph∆∞∆°ng th·ª©c kh√¥ng h·ª£p l·ªá'}, status=405)

    conn = connect_to_db()
    cursor = conn.cursor()
    
    try:
        magv = str(request.user.id)
        kichthuoc = request.POST.get('kichthuoc')
        nguong = request.POST.get('nguong')

        if not kichthuoc or not nguong:
            return JsonResponse({'status': 'fail', 'message': 'Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß k√≠ch th∆∞·ªõc v√† ng∆∞·ª°ng'})

        kichthuoc = int(kichthuoc)
        nguong = float(nguong)

        cursor.execute("SELECT COUNT(*) FROM setting WHERE magv = ?", (magv,))
        exists = cursor.fetchone()[0] > 0

        if exists:
            cursor.execute("UPDATE setting SET kichthuoc = ?, nguong = ? WHERE magv = ?", 
                         (kichthuoc, nguong, magv))
        else:
            cursor.execute("INSERT INTO setting (magv, kichthuoc, nguong) VALUES (?, ?, ?)",
                         (magv, kichthuoc, nguong))

        conn.commit()
        return JsonResponse({'status': 'success', 'message': 'L∆∞u c√†i ƒë·∫∑t th√†nh c√¥ng'})

    except ValueError as e:
        return JsonResponse({'status': 'fail', 'message': f'D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá: {str(e)}'})
    except Exception as e:
        print(f"L·ªói khi l∆∞u c√†i ƒë·∫∑t: {e}")
        return JsonResponse({'status': 'fail', 'message': f'L·ªói h·ªá th·ªëng: {str(e)}'})

    finally:
        cursor.close()
        conn.close()

@login_required(login_url="login")
def settings_view(request):
    conn = connect_to_db()
    cursor = conn.cursor()
    try:
        user_id = request.user.id  
        has_permission = superuser(user_id) 

        if request.method == "GET":
            if has_permission:
                cursor.execute("SELECT id, username, is_superuser, email, last_name FROM auth_user")
                users = [{'id': row[0], 'username': row[1], 'is_superuser': row[2], 'email': row[3], 'name': row[4]} for row in cursor.fetchall()]
            else:
                users = []  

            if request.headers.get('X-Requested-With') == 'XMLHttpRequest':
                return JsonResponse({'users': users, 'has_permission': has_permission})
            else:
                data = {'users': users, 'has_permission': has_permission, 'current_magv': str(user_id)}
                return render(request, 'settings.html', data)

        elif request.method == "POST":
            if not has_permission:
                return JsonResponse({'status': 'fail', 'message': 'Kh√¥ng ƒë·ªß quy·ªÅn ƒë·ªÉ th·ª±c hi·ªán h√†nh ƒë·ªông n√†y'}, status=403)

            action = request.POST.get('action')
            if action == 'add':
                username = request.POST.get('username')
                password = request.POST.get('password')
                name = request.POST.get('name')
                email = request.POST.get('email')
                is_superuser = request.POST.get('is_superuser')
                date = datetime.now().strftime('%Y-%m-%d %H:%M:%S.%f')

                if not username or not password:
                    return JsonResponse({'status': 'fail', 'message': 'Thi·∫øu username ho·∫∑c password'})

                cursor.execute("SELECT COUNT(*) FROM auth_user WHERE username = ?", (username,))
                if cursor.fetchone()[0] > 0:
                    return JsonResponse({'status': 'fail', 'message': 'Username ƒë√£ t·ªìn t·∫°i'})

                cursor.execute("SELECT COUNT(*) FROM auth_user WHERE email = ?", (email,))
                if cursor.fetchone()[0] > 0:
                    return JsonResponse({'status': 'fail', 'message': 'Gmail ƒë√£ t·ªìn t·∫°i'})

                hashed_password = make_password(password)
                cursor.execute(
                    "INSERT INTO auth_user (username, password, last_name, email, is_superuser, is_staff, is_active, date_joined) "
                    "VALUES (?, ?, ?, ?, ?, ?, ?, ?)",
                    (username, hashed_password, name, email, is_superuser, 1 if is_superuser else 0, 1, date)
                )
                conn.commit()
                return JsonResponse({'status': 'success', 'message': 'Th√™m t√†i kho·∫£n th√†nh c√¥ng'})

            elif action == 'update':
                user_id_to_update = request.POST.get('user_id')
                is_superuser = request.POST.get('is_superuser')
                username = request.POST.get('username')
                name = request.POST.get('name')
                email = request.POST.get('email')
                password = request.POST.get('password')

                if not user_id_to_update:
                    return JsonResponse({'status': 'fail', 'message': 'Thi·∫øu user_id'})

                if username:
                    cursor.execute("SELECT COUNT(*) FROM auth_user WHERE username = ? AND id != ?", (username, user_id_to_update))
                    if cursor.fetchone()[0] > 0:
                        return JsonResponse({'status': 'fail', 'message': 'Username ƒë√£ t·ªìn t·∫°i'})

                if email:
                    cursor.execute("SELECT COUNT(*) FROM auth_user WHERE email = ? AND id != ?", (email, user_id_to_update))
                    if cursor.fetchone()[0] > 0:
                        return JsonResponse({'status': 'fail', 'message': 'Email ƒë√£ t·ªìn t·∫°i'})

                if password:
                    hashed_password = make_password(password)
                    cursor.execute(
                        "UPDATE auth_user SET username = ?, last_name = ?, email = ?, is_superuser = ?, password = ? WHERE id = ?",
                        (username or None, name or None, email or None,is_superuser, hashed_password, user_id_to_update)
                    )
                else:
                    cursor.execute(
                        "UPDATE auth_user SET username = ?, last_name = ?, email = ?, is_superuser = ? WHERE id = ?",
                        (username or None, name or None, email or None, is_superuser , user_id_to_update)
                    )

                if cursor.rowcount == 0:
                    return JsonResponse({'status': 'fail', 'message': 'Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng ƒë·ªÉ c·∫≠p nh·∫≠t'})
                conn.commit()
                return JsonResponse({'status': 'success', 'message': 'C·∫≠p nh·∫≠t t√†i kho·∫£n th√†nh c√¥ng'})

            elif action == 'delete':
                user_id_to_delete = request.POST.get('user_id')
                if not user_id_to_delete:
                    return JsonResponse({'status': 'fail', 'message': 'Thi·∫øu user_id'})
                if user_id_to_delete == str(user_id): 
                    return JsonResponse({'status': 'fail', 'message': 'Kh√¥ng th·ªÉ x√≥a t√†i kho·∫£n ƒëang ƒëƒÉng nh·∫≠p'})

                cursor.execute("DELETE FROM auth_user WHERE id = ?", (user_id_to_delete,))
                if cursor.rowcount == 0:
                    return JsonResponse({'status': 'fail', 'message': 'Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng ƒë·ªÉ x√≥a'})
                conn.commit()
                return JsonResponse({'status': 'success', 'message': 'X√≥a t√†i kho·∫£n th√†nh c√¥ng'})

            return JsonResponse({'status': 'fail', 'message': 'H√†nh ƒë·ªông kh√¥ng h·ª£p l·ªá'})

        else:
            return JsonResponse({'status': 'fail', 'message': 'Ph∆∞∆°ng th·ª©c kh√¥ng h·ª£p l·ªá'}, status=405)

    except Exception as e:
        print(f"Error in settings_view: {e}")
        if request.headers.get('X-Requested-With') == 'XMLHttpRequest':
            return JsonResponse({'status': 'fail', 'message': f'Error: {str(e)}'})
        return HttpResponseServerError(f'Error: {str(e)}')
    finally:
        cursor.close()
        conn.close()

@login_required(login_url="login")
def get_available_classes(request):
    conn = connect_to_db()
    cursor = conn.cursor()

    try:
        magv = str(request.user.id)
        current_date = datetime.now().strftime('%Y-%m-%d')
        cursor.execute("""
            SELECT DISTINCT lophp, tiet, magv 
            FROM lich 
            WHERE ngay = ? AND magv = ?
            ORDER BY lophp, tiet
        """, (current_date, magv))
        schedule = cursor.fetchall()

        available_classes = list(set(row[0] for row in schedule))
        available_periods = list(set(row[1] for row in schedule))

        data = {
            'status': 'success',
            'classes': available_classes,
            'periods': available_periods,
            'magv': [magv], 
            'schedule': [{'lophp': row[0], 'tiet': row[1], 'magv': row[2]} for row in schedule]
        }
        print(f"DEBUG: Available classes for magv {magv}: {data}") 
        return JsonResponse(data)

    except Exception as e:
        print(f"L·ªói khi l·∫•y l·ªãch h·ªçc: {e}")
        return JsonResponse({'status': 'fail', 'message': f'L·ªói: {str(e)}'})

    finally:
        cursor.close()
        conn.close()

@csrf_exempt
def diemdanh(request):
    if request.method == "POST":
        try:
            image_data = request.POST.get('image')
            lophp = request.POST.get('lophp')
            tiet = request.POST.get('tiet')

            if not image_data:
                return JsonResponse({'success': False, 'message': 'Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ·∫£nh!'})
            if not lophp or not tiet:
                return JsonResponse({'success': False, 'message': 'Vui l√≤ng ch·ªçn l·ªõp v√† ti·∫øt!'})

            magv = str(request.user.id)

            format, imgstr = image_data.split(';base64,')
            ext = format.split('/')[-1]
            data = ContentFile(base64.b64decode(imgstr), name=f'temp.{ext}')

            nparr = np.frombuffer(data.read(), np.uint8)
            frame = cv2.imdecode(nparr, cv2.IMREAD_COLOR)

            detected_labels = detect_face(frame, lophp, request)

            if detected_labels:
                for detection in detected_labels:
                    label = detection['label']
                    if label != "Unknown":
                        mssv = label.split('_')[0]
                        conn = connect_to_db()
                        cursor = conn.cursor()
                        
                        current_date = datetime.now().strftime('%Y-%m-%d')
                        cursor.execute("""
                            SELECT malich 
                            FROM lich 
                            WHERE lophp = ? AND tiet = ? AND ngay = ? AND magv = ?
                        """, (lophp, tiet, current_date, magv))
                        lich_row = cursor.fetchone()
                        
                        if not lich_row:
                            conn.close()
                            return JsonResponse({'success': False, 'message': 'Kh√¥ng t√¨m th·∫•y l·ªãch h·ªçc ph√π h·ª£p ho·∫∑c b·∫°n kh√¥ng c√≥ quy·ªÅn ƒëi·ªÉm danh l·ªõp n√†y!'})
                        
                        malich = lich_row[0]
                        print("M√£ l·ªãch:", malich)

                        # Ki·ªÉm tra xem sinh vi√™n ƒë√£ ƒëi·ªÉm danh trong 1 ph√∫t g·∫ßn nh·∫•t ch∆∞a
                        one_minute_ago = (datetime.now() - timedelta(minutes=1)).strftime('%Y-%m-%d %H:%M:%S')
                        cursor.execute("""
                            SELECT time 
                            FROM diemdanh 
                            WHERE mssv = ? AND malich = ? AND time >= ?
                        """, (mssv, malich, one_minute_ago))
                        recent_diemdanh = cursor.fetchone()

                        if recent_diemdanh:
                            cursor.execute("SELECT name FROM thongtin WHERE mssv = ?", (mssv,))
                            student = cursor.fetchone()
                            conn.close()
                            return JsonResponse({
                                'success': False,
                                'mssv': mssv,
                                'name': student[0] if student else 'Unknown',
                                'labels': detected_labels,
                                'message': 'Sinh vi√™n ƒë√£ ƒë∆∞·ª£c ƒëi·ªÉm danh trong 1 ph√∫t g·∫ßn nh·∫•t!'
                            })

                        # N·∫øu ch∆∞a ƒëi·ªÉm danh, ti·∫øp t·ª•c x·ª≠ l√Ω
                        cursor.execute("SELECT name FROM thongtin WHERE mssv = ?", (mssv,))
                        student = cursor.fetchone()
                        
                        if student:
                            name = student[0]
                            current_time = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
                            
                            cursor.execute("""
                                INSERT INTO diemdanh (mssv, time, malich)
                                VALUES (?, ?, ?)
                            """, (mssv, current_time, malich))
                            conn.commit()
                            
                            conn.close()
                            return JsonResponse({
                                'success': True,
                                'mssv': mssv,
                                'name': name,
                                'lophp': lophp,
                                'tiet': tiet,
                                'magv': magv,  
                                'time': current_time,
                                'labels': detected_labels,
                                'message': 'ƒê√£ ƒëi·ªÉm danh'
                            })
                        
                        conn.close()
            return JsonResponse({
                'success': False,
                'labels': detected_labels,
                'message': 'Kh√¥ng nh·∫≠n di·ªán ƒë∆∞·ª£c khu√¥n m·∫∑t'
            })
            
        except Exception as e:
            print(f"L·ªói: {str(e)}")
            return JsonResponse({'success': False, 'message': f'L·ªói h·ªá th·ªëng: {str(e)}'})
    
    return JsonResponse({'success': False, 'message': 'Ph∆∞∆°ng th·ª©c kh√¥ng h·ª£p l·ªá'})

@login_required(login_url="login")
def get_attendance_history(request):
    lophp = request.GET.get('lophp')
    tiet = request.GET.get('tiet')
    magv = str(request.user.id)

    if not lophp or not tiet:
        return JsonResponse({'status': 'fail', 'message': 'Vui l√≤ng cung c·∫•p l·ªõp v√† ti·∫øt'})

    conn = connect_to_db()
    cursor = conn.cursor()

    try:
        current_date = datetime.now().strftime('%Y-%m-%d')
        cursor.execute("""
            SELECT malich 
            FROM lich 
            WHERE lophp = ? AND tiet = ? AND ngay = ? AND magv = ?
        """, (lophp, tiet, current_date, magv))
        lich_row = cursor.fetchone()

        if not lich_row:
            return JsonResponse({'status': 'fail', 'message': 'Kh√¥ng t√¨m th·∫•y l·ªãch h·ªçc ph√π h·ª£p'})

        malich = lich_row[0]

        cursor.execute("""
            SELECT diemdanh.mssv, thongtin.name, diemdanh.time 
            FROM diemdanh 
            INNER JOIN thongtin ON diemdanh.mssv = thongtin.mssv 
            WHERE diemdanh.malich = ?
            ORDER BY diemdanh.time DESC
        """, (malich,))
        history = cursor.fetchall()

        data = {
            'status': 'success',
            'history': [
                {
                    'mssv': row[0],
                    'name': row[1]
                } for row in history
            ]
        }
        return JsonResponse(data)

    except Exception as e:
        print(f"L·ªói khi l·∫•y l·ªãch s·ª≠ ƒëi·ªÉm danh: {e}")
        return JsonResponse({'status': 'fail', 'message': f'L·ªói: {str(e)}'})

    finally:
        cursor.close()
        conn.close()

def vietnamese_last_word_sort_key(name):
    words = name.strip().split()
    last_word = words[-1] if words else "" 
    
    last_word_no_accent = unidecode(last_word).lower()
    
    vietnamese_order = (
        'a', 'ƒÉ', '√¢', 'b', 'c', 'd', 'ƒë', 'e', '√™', 'g', 'h', 'i', 
        'k', 'l', 'm', 'n', 'o', '√¥', '∆°', 'p', 'q', 'r', 's', 't', 
        'u', '∆∞', 'v', 'x', 'y'
    )
    
    first_char = last_word_no_accent[0] if last_word_no_accent else ''
    sort_index = vietnamese_order.index(first_char) if first_char in vietnamese_order else float('inf')
    return (sort_index, last_word_no_accent, unidecode(name).lower())  

@login_required(login_url="login")
def get_class_members(request):
    lophp = request.GET.get('lophp')
    tiet = request.GET.get('tiet')
    magv = str(request.user.id)
    if not lophp or not tiet:
        return JsonResponse({'status': 'fail', 'message': 'Vui l√≤ng cung c·∫•p l·ªõp v√† ti·∫øt'})

    conn = connect_to_db()
    cursor = conn.cursor()

    try:
        current_date = datetime.now().strftime('%Y-%m-%d')
        cursor.execute("""
            SELECT malich 
            FROM lich 
            WHERE lophp = ? AND tiet = ? AND ngay = ? AND magv = ?
        """, (lophp, tiet, current_date,magv))
        lich_row = cursor.fetchone()

        malich = lich_row[0] if lich_row else None

        cursor.execute("""
            SELECT DISTINCT thongtin.mssv, thongtin.name, thongtin.lop 
            FROM thongtin 
            INNER JOIN dkmh ON dkmh.mssv = thongtin.mssv 
            WHERE dkmh.lophp = ?
        """, (lophp,))
        students = cursor.fetchall()

        students_sorted = sorted(students, key=lambda x: vietnamese_last_word_sort_key(x[1]))

        attended_students = set()
        if malich:
            cursor.execute("""
                SELECT mssv 
                FROM diemdanh 
                WHERE malich = ?
            """, (malich,))
            attended_students = set(row[0] for row in cursor.fetchall())

        data = {
            'members': [
                {
                    'stt': idx + 1, 
                    'mssv': student[0],
                    'name': student[1],  
                    'lophp': student[2],
                    'attended': student[0] in attended_students
                }
                for idx, student in enumerate(students_sorted)
            ]
        }
        return JsonResponse(data)

    except Exception as e:
        print(f"L·ªói khi truy v·∫•n d·ªØ li·ªáu th√†nh vi√™n l·ªõp: {e}")
        return JsonResponse({'status': 'fail', 'message': 'L·ªói khi l·∫•y d·ªØ li·ªáu th√†nh vi√™n l·ªõp'})

    finally:
        cursor.close()
        conn.close()
@csrf_exempt
def manual_attendance(request):
    if request.method == "POST":
        try:
            mssv = request.POST.get('mssv')
            lophp = request.POST.get('lophp')
            tiet = request.POST.get('tiet')
            attended = request.POST.get('attended') 
            magv = str(request.user.id)
            if not mssv or not lophp or not tiet:
                return JsonResponse({'success': False, 'message': 'Thi·∫øu th√¥ng tin c·∫ßn thi·∫øt!'})

            conn = connect_to_db()
            cursor = conn.cursor()

            current_date = datetime.now().strftime('%Y-%m-%d')
            cursor.execute("""
                SELECT malich 
                FROM lich 
                WHERE lophp = ? AND tiet = ? AND ngay = ? And magv = ?
            """, (lophp, tiet, current_date,magv))
            lich_row = cursor.fetchone()

            if not lich_row:
                conn.close()
                return JsonResponse({'success': False, 'message': 'Kh√¥ng t√¨m th·∫•y l·ªãch h·ªçc ph√π h·ª£p!'})
            
            malich = lich_row[0]

            cursor.execute("SELECT name FROM thongtin WHERE mssv = ?", (mssv,))
            student = cursor.fetchone()
            if not student:
                conn.close()
                return JsonResponse({'success': False, 'message': 'Kh√¥ng t√¨m th·∫•y sinh vi√™n!'})

            if (attended =="true"):
                current_time = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
                cursor.execute("""
                    INSERT INTO diemdanh (mssv, time, malich)
                    VALUES (?, ?, ?)
                """, (mssv, current_time, malich))
            else:
                cursor.execute("""
                    DELETE FROM diemdanh 
                    WHERE mssv = ? AND malich = ?
                """, (mssv, malich))

            conn.commit()
            conn.close()
            return JsonResponse({'success': True, 'message': 'C·∫≠p nh·∫≠t ƒëi·ªÉm danh th√†nh c√¥ng'})

        except Exception as e:
            print(f"L·ªói khi c·∫≠p nh·∫≠t ƒëi·ªÉm danh th·ªß c√¥ng: {e}")
            return JsonResponse({'success': False, 'message': f'L·ªói h·ªá th·ªëng: {str(e)}'})

    return JsonResponse({'success': False, 'message': 'Ph∆∞∆°ng th·ª©c kh√¥ng h·ª£p l·ªá'})

DLL_PATH = os.path.join(os.path.dirname(os.path.abspath(__file__)), "models", "ftrScanAPI.dll")
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)
logger.addHandler(logging.StreamHandler())

def initialize_dll():
    try:
        if not os.path.exists(DLL_PATH):
            logger.error(f"‚ùå Kh√¥ng t√¨m th·∫•y file DLL t·∫°i: {DLL_PATH}")
            return None
            
        logger.info(f"üîç ƒêang t·∫£i DLL t·ª´: {DLL_PATH}")
        try:
            # ftr_scan = ctypes.CDLL(DLL_PATH)
            ftr_scan = ctypes.WinDLL(DLL_PATH)
            logger.info("‚úÖ ƒê√£ t·∫£i DLL th√†nh c√¥ng")
        except Exception as dll_error:
            logger.error(f"‚ùå L·ªói khi t·∫£i DLL: {str(dll_error)}")
            return None
        
        # Ki·ªÉm tra c√°c h√†m c·∫ßn thi·∫øt
        required_functions = [
            'ftrScanOpenDevice',
            'ftrScanCloseDevice', 
            'ftrScanGetImageSize',
            'ftrScanGetImage',
            'ftrScanGetDeviceInfo',
            'ftrScanIsFingerPresent'
        ]
        
        missing_functions = []
        for func in required_functions:
            if not hasattr(ftr_scan, func):
                missing_functions.append(func)
                logger.error(f"‚ùå Kh√¥ng t√¨m th·∫•y h√†m {func} trong DLL")
        
        if missing_functions:
            logger.error(f"‚ùå Thi·∫øu c√°c h√†m sau trong DLL: {', '.join(missing_functions)}")
            return None
                
        # C·∫•u h√¨nh c√°c h√†m
        try:
            ftr_scan.ftrScanOpenDevice.argtypes = [ctypes.c_int, ctypes.c_int]
            ftr_scan.ftrScanOpenDevice.restype = wintypes.HANDLE
            
            ftr_scan.ftrScanCloseDevice.argtypes = [wintypes.HANDLE]
            ftr_scan.ftrScanCloseDevice.restype = None
            
            ftr_scan.ftrScanGetImageSize.argtypes = [wintypes.HANDLE, ctypes.POINTER(ctypes.c_ulong)]
            ftr_scan.ftrScanGetImageSize.restype = ctypes.c_bool
            
            ftr_scan.ftrScanGetImage.argtypes = [wintypes.HANDLE, ctypes.c_int, ctypes.POINTER(ctypes.c_ubyte)]
            ftr_scan.ftrScanGetImage.restype = ctypes.c_bool
            
            ftr_scan.ftrScanGetDeviceInfo.argtypes = [wintypes.HANDLE, ctypes.POINTER(ctypes.c_char)]
            ftr_scan.ftrScanGetDeviceInfo.restype = ctypes.c_bool
            
            ftr_scan.ftrScanIsFingerPresent.argtypes = [wintypes.HANDLE, ctypes.POINTER(ctypes.c_bool)]
            ftr_scan.ftrScanIsFingerPresent.restype = ctypes.c_bool
            
            logger.info("‚úÖ ƒê√£ c·∫•u h√¨nh c√°c h√†m th√†nh c√¥ng")
        except Exception as config_error:
            logger.error(f"‚ùå L·ªói khi c·∫•u h√¨nh c√°c h√†m: {str(config_error)}")
            return None
        
        return ftr_scan
        
    except Exception as e:
        logger.error(f"‚ùå L·ªói khi kh·ªüi t·∫°o DLL: {str(e)}")
        return None

# Kh·ªüi t·∫°o DLL
ftr_scan = initialize_dll()

def initialize_fingerprint_sensor():
    try:
        logger.info("üîç B·∫Øt ƒë·∫ßu kh·ªüi t·∫°o c·∫£m bi·∫øn v√¢n tay FS80...")
        print("==> [DEBUG] B·∫Øt ƒë·∫ßu kh·ªüi t·∫°o c·∫£m bi·∫øn v√¢n tay FS80...")

        if not ftr_scan:
            logger.error("‚ùå DLL ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o th√†nh c√¥ng!")
            print("==> [DEBUG] DLL ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o th√†nh c√¥ng!")
            return None

        try:
            handle = ftr_scan.ftrScanOpenDevice(0, 0)
            print("==> [DEBUG] ftrScanOpenDevice tr·∫£ v·ªÅ:", handle)
            if not handle or handle == 0:
                logger.error("‚ùå Kh√¥ng th·ªÉ m·ªü thi·∫øt b·ªã FS80! Ki·ªÉm tra k·∫øt n·ªëi USB v√† driver.")
                print("==> [DEBUG] Kh√¥ng th·ªÉ m·ªü thi·∫øt b·ªã FS80! Ki·ªÉm tra k·∫øt n·ªëi USB v√† driver.")
                return None
            logger.info("‚úÖ ƒê√£ m·ªü thi·∫øt b·ªã FS80 th√†nh c√¥ng!")
            print("==> [DEBUG] ƒê√£ m·ªü thi·∫øt b·ªã FS80 th√†nh c√¥ng!")
        except Exception as open_error:
            logger.error(f"‚ùå L·ªói khi m·ªü thi·∫øt b·ªã: {str(open_error)}")
            print("==> [DEBUG] L·ªói khi m·ªü thi·∫øt b·ªã:", open_error)
            return None

        # Ki·ªÉm tra tr·∫°ng th√°i thi·∫øt b·ªã
        try:
            info_buffer = (ctypes.c_char * 256)()
            result = ftr_scan.ftrScanGetDeviceInfo(handle, info_buffer)
            print("==> [DEBUG] ftrScanGetDeviceInfo tr·∫£ v·ªÅ:", result)
            if result:
                info_str = bytes(info_buffer).split(b'\x00', 1)[0].decode(errors='ignore')
                print("==> [DEBUG] Th√¥ng tin thi·∫øt b·ªã:", info_str)
            else:
                logger.error("‚ùå Kh√¥ng th·ªÉ l·∫•y th√¥ng tin thi·∫øt b·ªã!")
                print("==> [DEBUG] Kh√¥ng th·ªÉ l·∫•y th√¥ng tin thi·∫øt b·ªã!")
                ftr_scan.ftrScanCloseDevice(handle)
                return None
            logger.info(f"‚úÖ Th√¥ng tin thi·∫øt b·ªã: {info_str}")
            print("==> [DEBUG] Th√¥ng tin thi·∫øt b·ªã:", info_str)
        except Exception as info_error:
            logger.error(f"‚ùå L·ªói khi l·∫•y th√¥ng tin thi·∫øt b·ªã: {str(info_error)}")
            print("==> [DEBUG] L·ªói khi l·∫•y th√¥ng tin thi·∫øt b·ªã:", info_error)
            ftr_scan.ftrScanCloseDevice(handle)
            return None

        # Ki·ªÉm tra xem c·∫£m bi·∫øn c√≥ s·∫µn s√†ng kh√¥ng
        try:
            test_size = ctypes.c_ulong()
            result = ftr_scan.ftrScanGetImageSize(handle, ctypes.byref(test_size))
            print("==> [DEBUG] ftrScanGetImageSize tr·∫£ v·ªÅ:", result)
            if not result:
                logger.error("‚ùå C·∫£m bi·∫øn kh√¥ng ph·∫£n h·ªìi khi ki·ªÉm tra k√≠ch th∆∞·ªõc ·∫£nh!")
                print("==> [DEBUG] C·∫£m bi·∫øn kh√¥ng ph·∫£n h·ªìi khi ki·ªÉm tra k√≠ch th∆∞·ªõc ·∫£nh!")
                ftr_scan.ftrScanCloseDevice(handle)
                return None
            logger.info(f"‚úÖ C·∫£m bi·∫øn ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng. K√≠ch th∆∞·ªõc ·∫£nh: {test_size.value} bytes")
            print("==> [DEBUG] K√≠ch th∆∞·ªõc ·∫£nh:", test_size.value)
        except Exception as size_error:
            logger.error(f"‚ùå L·ªói khi ki·ªÉm tra k√≠ch th∆∞·ªõc ·∫£nh: {str(size_error)}")
            print("==> [DEBUG] L·ªói khi ki·ªÉm tra k√≠ch th∆∞·ªõc ·∫£nh:", size_error)
            ftr_scan.ftrScanCloseDevice(handle)
            return None

        return handle
        
    except Exception as e:
        logger.error(f"‚ùå L·ªói khi kh·ªüi t·∫°o c·∫£m bi·∫øn: {str(e)}")
        if 'handle' in locals() and handle:
            try:
                ftr_scan.ftrScanCloseDevice(handle)
            except:
                pass
        return None

# Kh·ªüi t·∫°o c·∫£m bi·∫øn khi module ƒë∆∞·ª£c load
fingerprint_sensor = initialize_fingerprint_sensor()

# ƒê·ªãnh nghƒ©a c√°c h√†m callback
def on_finger_present(handle, finger_present):
    if finger_present:
        logger.info("‚úÖ Ph√°t hi·ªán ng√≥n tay tr√™n c·∫£m bi·∫øn!")
    else:
        logger.info("‚ö†Ô∏è Kh√¥ng ph√°t hi·ªán ng√≥n tay tr√™n c·∫£m bi·∫øn!")

# ƒêƒÉng k√Ω callback
if fingerprint_sensor:
    ftr_scan.ftrScanSetFingerPresentCallback(fingerprint_sensor, on_finger_present)
    logger.info("‚úÖ ƒê√£ ƒëƒÉng k√Ω callback ph√°t hi·ªán ng√≥n tay")

ftr_scan.ftrScanIsFingerPresent.argtypes = [wintypes.HANDLE, ctypes.POINTER(ctypes.c_bool)]
ftr_scan.ftrScanIsFingerPresent.restype = ctypes.c_bool

def check_sensor_status():
    try:
        if not fingerprint_sensor:
            return False, "C·∫£m bi·∫øn ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o"
            
        # Ki·ªÉm tra k·∫øt n·ªëi
        info_buffer = (ctypes.c_char * 256)()
        if not ftr_scan.ftrScanGetDeviceInfo(fingerprint_sensor, info_buffer):
            return False, "Kh√¥ng th·ªÉ l·∫•y th√¥ng tin thi·∫øt b·ªã"
            
        # Ki·ªÉm tra tr·∫°ng th√°i
        test_size = ctypes.c_ulong()
        if not ftr_scan.ftrScanGetImageSize(fingerprint_sensor, ctypes.byref(test_size)):
            return False, "C·∫£m bi·∫øn kh√¥ng ph·∫£n h·ªìi"
            
        # Ki·ªÉm tra ng√≥n tay
        finger_present = ctypes.c_bool()
        if not ftr_scan.ftrScanIsFingerPresent(fingerprint_sensor, ctypes.byref(finger_present)):
            return False, "Kh√¥ng th·ªÉ ki·ªÉm tra tr·∫°ng th√°i ng√≥n tay"
            
        return True, "C·∫£m bi·∫øn ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng"
    except Exception as e:
        return False, f"L·ªói ki·ªÉm tra c·∫£m bi·∫øn: {str(e)}"

@csrf_exempt
@login_required(login_url="login")
def register_fingerprint(request):
    if request.method == "POST":
        try:
            mssv = request.POST.get('mssv')
            name = request.POST.get('name')
            if not mssv or not name:
                return JsonResponse({'success': False, 'message': 'Vui l√≤ng cung c·∫•p ƒë·∫ßy ƒë·ªß MSSV v√† t√™n!'})

            sensor = initialize_fingerprint_sensor()
            if not sensor:
                return JsonResponse({'success': False, 'message': 'C·∫£m bi·∫øn ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o'})

            # Ki·ªÉm tra tr·∫°ng th√°i c·∫£m bi·∫øn
            sensor_ok, sensor_message = check_sensor_status()
            if not sensor_ok:
                return JsonResponse({'success': False, 'message': f'L·ªói c·∫£m bi·∫øn: {sensor_message}'})

            conn = connect_to_db()
            cursor = conn.cursor()
            
            # Ki·ªÉm tra xem sinh vi√™n ƒë√£ t·ªìn t·∫°i ch∆∞a
            cursor.execute("SELECT name FROM thongtin WHERE mssv = ?", (mssv,))
            student = cursor.fetchone()
            
            if not student:
                # Th√™m sinh vi√™n m·ªõi n·∫øu ch∆∞a t·ªìn t·∫°i
                cursor.execute("INSERT INTO thongtin (mssv, name) VALUES (?, ?)", (mssv, name))
                conn.commit()
            
            # ƒê·ªçc v√¢n tay t·ª´ c·∫£m bi·∫øn
            image_size = ctypes.c_ulong()
            if not ftr_scan.ftrScanGetImageSize(sensor, ctypes.byref(image_size)):
                return JsonResponse({'success': False, 'message': 'Kh√¥ng th·ªÉ ƒë·ªçc k√≠ch th∆∞·ªõc ·∫£nh v√¢n tay!'})
            
            image_buffer = (ctypes.c_ubyte * image_size.value)()
            
            # Ch·ªù ng√≥n tay
            finger_present = ctypes.c_bool()
            logger.info("Vui l√≤ng ƒë·∫∑t ng√≥n tay l√™n c·∫£m bi·∫øn...")
            time.sleep(2)  # Ch·ªù 2 gi√¢y ƒë·ªÉ ƒë·∫∑t ng√≥n tay
            
            if not ftr_scan.ftrScanIsFingerPresent(sensor, ctypes.byref(finger_present)) or not finger_present.value:
                return JsonResponse({'success': False, 'message': 'Kh√¥ng ph√°t hi·ªán ng√≥n tay tr√™n c·∫£m bi·∫øn!'})
            
            # ƒê·ªçc ·∫£nh v√¢n tay
            if not ftr_scan.ftrScanGetImage(sensor, image_buffer, image_size):
                return JsonResponse({'success': False, 'message': 'Kh√¥ng th·ªÉ ƒë·ªçc ·∫£nh v√¢n tay!'})
            
            # Chuy·ªÉn ƒë·ªïi ·∫£nh v√¢n tay th√†nh chu·ªói base64
            import base64
            image_bytes = bytes(image_buffer)
            image_base64 = base64.b64encode(image_bytes).decode('utf-8')
            
            # L∆∞u v√¢n tay v√†o database
            cursor.execute("UPDATE thongtin SET vantay = ? WHERE mssv = ?", (image_base64, mssv))
            conn.commit()
            conn.close()
            
            # Cu·ªëi c√πng:
            ftr_scan.ftrScanCloseDevice(sensor)
            return JsonResponse({
                'success': True,
                'message': 'ƒêƒÉng k√Ω v√¢n tay th√†nh c√¥ng!',
                'mssv': mssv,
                'name': name,
                'fingerprint_image': f'data:image/jpeg;base64,{image_base64}'
            })
            
        except Exception as e:
            logger.error(f"L·ªói khi ƒëƒÉng k√Ω v√¢n tay: {e}")
            # N·∫øu c√≥ l·ªói, c≈©ng n√™n ƒë√≥ng sensor n·∫øu ƒë√£ m·ªü
            try:
                if sensor:
                    ftr_scan.ftrScanCloseDevice(sensor)
            except:
                pass
            return JsonResponse({'success': False, 'message': f'L·ªói h·ªá th·ªëng: {str(e)}'})
    
    return JsonResponse({'success': False, 'message': 'Ph∆∞∆°ng th·ª©c kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£!'})

@csrf_exempt
@login_required(login_url="login")
def diemdanh_vantay(request):
    if request.method == "POST":
        try:
            lophp = request.POST.get('lophp')
            tiet = request.POST.get('tiet')
            
            if not lophp or not tiet:
                return JsonResponse({'success': False, 'message': 'Vui l√≤ng cung c·∫•p l·ªõp v√† ti·∫øt!'})
            
            sensor = get_fingerprint_sensor()
            if not sensor:
                return JsonResponse({'success': False, 'message': 'C·∫£m bi·∫øn ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o'})
            
            # ƒê·ªçc ·∫£nh v√¢n tay
            image_size = ctypes.c_ulong()
            if not ftr_scan.ftrScanGetImageSize(sensor, ctypes.byref(image_size)):
                return JsonResponse({'success': False, 'message': 'Kh√¥ng th·ªÉ ƒë·ªçc k√≠ch th∆∞·ªõc ·∫£nh v√¢n tay!'})
            
            image_buffer = (ctypes.c_ubyte * image_size.value)()
            if not ftr_scan.ftrScanGetImage(sensor, image_buffer, image_size):
                return JsonResponse({'success': False, 'message': 'Kh√¥ng th·ªÉ ƒë·ªçc ·∫£nh v√¢n tay!'})
            
            # Chuy·ªÉn ƒë·ªïi ·∫£nh v√¢n tay th√†nh chu·ªói base64
            import base64
            image_bytes = bytes(image_buffer)
            image_base64 = base64.b64encode(image_bytes).decode('utf-8')
            
            # T√¨m ki·∫øm v√¢n tay trong database
            conn = connect_to_db()
            cursor = conn.cursor()
            cursor.execute("SELECT mssv, name FROM thongtin WHERE vantay = ?", (image_base64,))
            student = cursor.fetchone()
            
            if not student:
                conn.close()
                return JsonResponse({'success': False, 'message': 'Kh√¥ng t√¨m th·∫•y v√¢n tay trong h·ªá th·ªëng!'})
            
            mssv, name = student
            
            # Ki·ªÉm tra xem sinh vi√™n ƒë√£ ƒëi·ªÉm danh ch∆∞a
            cursor.execute("""
                SELECT COUNT(*) FROM diemdanh 
                WHERE mssv = ? AND lophp = ? AND tiet = ? AND ngay = DATE('now')
            """, (mssv, lophp, tiet))
            
            if cursor.fetchone()[0] > 0:
                conn.close()
                return JsonResponse({'success': False, 'message': 'Sinh vi√™n ƒë√£ ƒëi·ªÉm danh!'})
            
            # Th√™m ƒëi·ªÉm danh
            cursor.execute("""
                INSERT INTO diemdanh (mssv, lophp, tiet, ngay, thoigian)
                VALUES (?, ?, ?, DATE('now'), TIME('now'))
            """, (mssv, lophp, tiet))
            
            conn.commit()
            conn.close()
            
            return JsonResponse({
                'success': True,
                'message': 'ƒêi·ªÉm danh th√†nh c√¥ng!',
                'mssv': mssv,
                'name': name
            })
            
        except Exception as e:
            logger.error(f"L·ªói khi ƒëi·ªÉm danh b·∫±ng v√¢n tay: {e}")
            return JsonResponse({'success': False, 'message': f'L·ªói h·ªá th·ªëng: {str(e)}'})
    
    return JsonResponse({'success': False, 'message': 'Ph∆∞∆°ng th·ª©c kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£!'})

@csrf_exempt
@login_required(login_url="login")
def them_sv(request):
    from .traning import train_new_student  

    if request.method == "POST":
        mssv = request.POST.get("mssv").upper()
        ten =" ".join(word.capitalize() for word in request.POST.get("name").split())
        lop = request.POST.get("lop").upper()
        images = request.FILES.getlist("images")

        if not mssv or not ten or not lop:
            return JsonResponse({"error": "Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin"}, status=400)

        if not images:
            return JsonResponse({"error": "Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt ·∫£nh"}, status=400)

        conn = connect_to_db()
        cursor = conn.cursor()
        
        try:
            # cursor.execute("SELECT COUNT(*) FROM thongtin WHERE mssv = ?", (mssv,))
            # if cursor.fetchone()[0] > 0:
            #     return JsonResponse({"error": f"MSSV {mssv} ƒë√£ t·ªìn t·∫°i trong h·ªá th·ªëng"}, status=400)

            success, message = train_new_student(mssv, ten, lop, images)
            if not success:
                return JsonResponse({"error": message}, status=400)

            return JsonResponse({"message": message})

        except Exception as e:
            import traceback
            traceback.print_exc()
            return JsonResponse({"error": f"L·ªói h·ªá th·ªëng: {str(e)}"}, status=500)
        
        finally:
            cursor.close()
            conn.close()

    return JsonResponse({"error": "Ph∆∞∆°ng th·ª©c kh√¥ng h·ª£p l·ªá"}, status=405)

@csrf_exempt
@login_required(login_url="login")
def add_folder(request):
    from .traning import train_new_student  # Import t·ª´ traning.py

    if request.method == "POST":
        conn = connect_to_db()
        cursor = conn.cursor()

        added_students = []
        errors = []

        try:
            files = request.FILES.getlist('files[]')
            relative_paths = {key: value for key, value in request.POST.items() if key.startswith('relative_paths[')}
            if not files:
                return JsonResponse({"error": "Kh√¥ng c√≥ file n√†o ƒë∆∞·ª£c ch·ªçn"}, status=400)

            # Nh√≥m c√°c file theo MSSV d·ª±a tr√™n relative_paths
            students_files = {}
            for i, file in enumerate(files):
                relative_path_key = f"relative_paths[{i}]"
                relative_path = relative_paths.get(relative_path_key, '')
                if not relative_path or relative_path.strip() == "":
                    errors.append(f"File {file.name} kh√¥ng c√≥ ƒë∆∞·ªùng d·∫´n t∆∞∆°ng ƒë·ªëi, vui l√≤ng ch·ªçn th∆∞ m·ª•c")
                    continue
                path_parts = relative_path.split('/')
                if len(path_parts) < 2:
                    errors.append(f"ƒê∆∞·ªùng d·∫´n {relative_path} kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng th∆∞ m·ª•c con")
                    continue
                folder_name = path_parts[1]
                if folder_name not in students_files:
                    students_files[folder_name] = []
                students_files[folder_name].append(file)

            if not students_files:
                return JsonResponse({"error": "Kh√¥ng t√¨m th·∫•y th∆∞ m·ª•c h·ª£p l·ªá", "errors": errors}, status=400)

            for folder_name, images in students_files.items():
                parts = folder_name.split("_")
                if len(parts) < 3:
                    errors.append(f"T√™n th∆∞ m·ª•c '{folder_name}' kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng (mssv_ten_lop)")
                    continue

                mssv = parts[0].upper()  
                ten = " ".join(word.capitalize() for word in parts[1].split()) 
                lop = "_".join(parts[2:]).upper()  
                ten_co_dau = ten

                cursor.execute("SELECT COUNT(*) FROM thongtin WHERE mssv = ?", (mssv,))
                if cursor.fetchone()[0] > 0:
                    errors.append(f"MSSV {mssv} ƒë√£ t·ªìn t·∫°i, b·ªè qua")
                    continue

                success, message = train_new_student(mssv, ten_co_dau, lop, images)
                if not success:
                    errors.append(f"Training th·∫•t b·∫°i cho {mssv}: {message}")
                    continue

                added_students.append({"mssv": mssv, "name": ten_co_dau, "lop": lop})

            if not added_students:
                return JsonResponse({"error": "Kh√¥ng c√≥ sinh vi√™n n√†o ƒë∆∞·ª£c th√™m", "errors": errors}, status=400)

            return JsonResponse({
                "message": "Th√™m sinh vi√™n v√† c·∫≠p nh·∫≠t database th√†nh c√¥ng",
                "added": added_students,
                "errors": errors if errors else []
            })

        except Exception as e:
            print(f"L·ªói h·ªá th·ªëng: {str(e)}")
            return JsonResponse({"error": "Ch·ªâ th√™m ƒë∆∞·ª£c t·ªëi ƒëa 20 sinh vi√™n m·ªôt l·∫ßn, m·ªói sinh vi√™n 5 ·∫£nh!"}, status=500)

        finally:
            cursor.close()
            conn.close()

    return JsonResponse({"error": "Y√™u c·∫ßu kh√¥ng h·ª£p l·ªá"}, status=400)

@login_required(login_url="login")
def get_weekly_schedule(request):
    start_date = request.GET.get('start_date')
    malich = request.GET.get('malich')
    magv = str(request.user.id)  # L·∫•y magv c·ªßa ng∆∞·ªùi d√πng hi·ªán t·∫°i
    
    if not start_date and not malich:
        return JsonResponse({'status': 'fail', 'message': 'Thi·∫øu ng√†y b·∫Øt ƒë·∫ßu ho·∫∑c m√£ l·ªãch'})
    
    try:
        conn = connect_to_db()
        cursor = conn.cursor()
        
        query = """
            SELECT malich, lophp, tiet, ngay 
            FROM lich 
            WHERE magv = ?
        """
        params = [magv]
        if malich:
            query += " AND malich = ?"
            params.append(str(malich))
        elif start_date:
            start = datetime.strptime(start_date, '%Y-%m-%d')
            end = start + timedelta(days=6)
            query += " AND ngay BETWEEN ? AND ?"
            params.extend([start.strftime('%Y-%m-%d'), end.strftime('%Y-%m-%d')])
        query += " ORDER BY lophp, ngay, tiet"
        
        cursor.execute(query, params)
        schedule_data = cursor.fetchall()
        print(f"DEBUG: D·ªØ li·ªáu l·ªãch trong get_weekly_schedule cho magv {magv}: {schedule_data}")  # Debug
        
        if not schedule_data:
            return JsonResponse({'status': 'success', 'schedule': {}})

        weekly_schedule = {}
        for row in schedule_data:
            malich, lophp, tiet, ngay = row
            if lophp not in weekly_schedule:
                weekly_schedule[lophp] = {
                    'mon': [], 'tue': [], 'wed': [], 'thu': [],
                    'fri': [], 'sat': [], 'sun': []
                }
            day = datetime.strptime(ngay, '%Y-%m-%d').weekday()
            day_map = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun']
            weekly_schedule[lophp][day_map[day]].append({
                'malich': str(malich),
                'tiet': tiet,
                'ngay': ngay
            })
        
        conn.close()
        print(f"DEBUG: weekly_schedule trong get_weekly_schedule: {weekly_schedule}")  # Debug
        return JsonResponse({'status': 'success', 'schedule': weekly_schedule})
    
    except Exception as e:
        print(f"DEBUG: L·ªói trong get_weekly_schedule: {str(e)}")  # Debug
        return JsonResponse({'status': 'fail', 'message': str(e)})

from django import template
register = template.Library()

@register.filter
def get_item(dictionary, key):
    return dictionary.get(key, [])

@login_required(login_url="login")
@admin_required_sql
def lich_view(request):
    conn = connect_to_db()
    cursor = conn.cursor()
    
    magv = str(request.user.id)  
    print(f"DEBUG: magv c·ªßa ng∆∞·ªùi d√πng hi·ªán t·∫°i: {magv}") 
    
    if request.method == "POST":
        action = request.POST.get('action')
        
        try:
            if action == 'add':
                cursor.execute("""
                    INSERT INTO lich (lophp, tiet, ngay, magv)
                    VALUES (?, ?, ?, ?)
                """, (
                    request.POST.get('lophp'),
                    request.POST.get('tiet'),
                    request.POST.get('ngay'),
                    magv,
                ))
                conn.commit()
                return JsonResponse({'status': 'success', 'message': 'Th√™m l·ªãch th√†nh c√¥ng'})

            elif action == 'edit':
                cursor.execute("""
                    UPDATE lich SET lophp=?, tiet=?, ngay=?, magv=?
                    WHERE malich=? AND magv=?
                """, (
                    request.POST.get('lophp'),
                    request.POST.get('tiet'),
                    request.POST.get('ngay'),
                    magv,
                    request.POST.get('malich'),
                    magv,
                ))
                if cursor.rowcount == 0:
                    return JsonResponse({'status': 'fail', 'message': 'Kh√¥ng t√¨m th·∫•y l·ªãch ƒë·ªÉ s·ª≠a ho·∫∑c b·∫°n kh√¥ng c√≥ quy·ªÅn'})
                conn.commit()
                return JsonResponse({'status': 'success', 'message': 'S·ª≠a l·ªãch th√†nh c√¥ng'})

            elif action == 'delete':
                malich = request.POST.get('malich')
                cursor.execute("DELETE FROM lich WHERE malich=? AND magv=?", (malich, magv))
                if cursor.rowcount == 0:
                    return JsonResponse({'status': 'fail', 'message': 'Kh√¥ng t√¨m th·∫•y l·ªãch ƒë·ªÉ x√≥a ho·∫∑c b·∫°n kh√¥ng c√≥ quy·ªÅn'})
                conn.commit()
                return JsonResponse({'status': 'success', 'message': 'X√≥a l·ªãch th√†nh c√¥ng'})

        except Exception as e:
            return JsonResponse({'status': 'fail', 'message': f'L·ªói: {str(e)}'})
        
        finally:
            conn.close()
    
    cursor.execute("SELECT DISTINCT lophp FROM lich WHERE magv = ?", (magv,))
    classes = [row[0] for row in cursor.fetchall()]
    
    weekly_schedule = {}
    for class_name in classes:
        weekly_schedule[class_name] = {
            'mon': [], 'tue': [], 'wed': [], 'thu': [],
            'fri': [], 'sat': [], 'sun': []
        }
        cursor.execute("""
            SELECT malich, lophp, tiet, ngay 
            FROM lich 
            WHERE lophp = ? AND magv = ?
            ORDER BY ngay, tiet
        """, (class_name, magv))
        schedule_data = cursor.fetchall()
        print(f"DEBUG: L·ªãch cho l·ªõp {class_name} v√† magv {magv}: {schedule_data}")  
        
        for row in schedule_data:
            malich, lophp, tiet, ngay = row
            day = datetime.strptime(ngay, '%Y-%m-%d').weekday()
            day_map = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun']
            weekly_schedule[lophp][day_map[day]].append({
                'malich': str(malich),
                'tiet': tiet,
                'ngay': ngay
            })
    
    conn.close()
    return render(request, 'lich.html', {'weekly_schedule': weekly_schedule})


@login_required(login_url="login")
def get_members(request):
    lophp = request.GET.get('lophp')

    if not lophp:
        return JsonResponse({'status': 'fail', 'message': 'Vui l√≤ng cung c·∫•p l·ªõp h·ªçc ph·∫ßn'})

    conn = connect_to_db()
    cursor = conn.cursor()

    try:
        cursor.execute("""
            SELECT DISTINCT thongtin.mssv, thongtin.name, thongtin.lop 
            FROM thongtin 
            INNER JOIN dkmh ON dkmh.mssv = thongtin.mssv 
            WHERE dkmh.lophp = ?
        """, (lophp,))
        students = cursor.fetchall()

        students_sorted = sorted(students, key=lambda x: vietnamese_last_word_sort_key(x[1]))

        data = {
            'status': 'success',
            'members': [
                {
                    'stt': idx + 1, 
                    'mssv': student[0],
                    'name': student[1],  
                    'lophp': student[2]
                }
                for idx, student in enumerate(students_sorted)
            ]
        }
        return JsonResponse(data)

    except Exception as e:
        print(f"L·ªói khi truy v·∫•n d·ªØ li·ªáu th√†nh vi√™n: {e}")
        return JsonResponse({'status': 'fail', 'message': 'L·ªói khi l·∫•y d·ªØ li·ªáu th√†nh vi√™n'})

    finally:
        cursor.close()
        conn.close()

@csrf_exempt
@login_required(login_url="login")
def add_student_to_class(request):
    if request.method == "POST":
        mssv = request.POST.get('mssv').upper()
        lophp = request.POST.get('lophp')

        if not mssv or not lophp:
            return JsonResponse({'status': 'fail', 'message': 'Thi·∫øu MSSV ho·∫∑c l·ªõp h·ªçc ph·∫ßn'})

        conn = connect_to_db()
        cursor = conn.cursor()

        try:
            cursor.execute("SELECT COUNT(*) FROM thongtin WHERE mssv = ?", (mssv,))
            if cursor.fetchone()[0] == 0:
                return JsonResponse({'status': 'fail', 'message': f'MSSV {mssv} kh√¥ng t·ªìn t·∫°i trong h·ªá th·ªëng'})

            cursor.execute("SELECT COUNT(*) FROM dkmh WHERE mssv = ? AND lophp = ?", (mssv, lophp))
            if cursor.fetchone()[0] > 0:
                return JsonResponse({'status': 'fail', 'message': f'Sinh vi√™n {mssv} ƒë√£ ƒëƒÉng k√Ω l·ªõp {lophp}'})

            cursor.execute("INSERT INTO dkmh (mssv, lophp) VALUES (?, ?)", (mssv, lophp))
            conn.commit()
            return JsonResponse({'status': 'success', 'message': f'Th√™m sinh vi√™n {mssv} v√†o l·ªõp {lophp} th√†nh c√¥ng'})

        except Exception as e:
            return JsonResponse({'status': 'fail', 'message': f'L·ªói h·ªá th·ªëng: {str(e)}'})
        
        finally:
            cursor.close()
            conn.close()
    return JsonResponse({'status': 'fail', 'message': 'Ph∆∞∆°ng th·ª©c kh√¥ng h·ª£p l·ªá'})

@csrf_exempt
@login_required(login_url="login")
def update_student_in_class(request):
    if request.method == "POST":
        old_mssv = request.POST.get('old_mssv')
        new_mssv = request.POST.get('new_mssv')
        lophp = request.POST.get('lophp')

        if not old_mssv or not new_mssv or not lophp:
            return JsonResponse({'status': 'fail', 'message': 'Thi·∫øu th√¥ng tin c·∫ßn thi·∫øt'})

        conn = connect_to_db()
        cursor = conn.cursor()

        try:
            cursor.execute("SELECT COUNT(*) FROM thongtin WHERE mssv = ?", (new_mssv,))
            if cursor.fetchone()[0] == 0:
                return JsonResponse({'status': 'fail', 'message': 'MSSV m·ªõi kh√¥ng t·ªìn t·∫°i trong h·ªá th·ªëng'})

            cursor.execute("UPDATE dkmh SET mssv = ? WHERE mssv = ? AND lophp = ?", (new_mssv, old_mssv, lophp))
            if cursor.rowcount == 0:
                return JsonResponse({'status': 'fail', 'message': 'Kh√¥ng t√¨m th·∫•y sinh vi√™n trong l·ªõp h·ªçc ph·∫ßn'})
            conn.commit()
            return JsonResponse({'status': 'success', 'message': 'S·ª≠a sinh vi√™n th√†nh c√¥ng'})

        except Exception as e:
            return JsonResponse({'status': 'fail', 'message': f'L·ªói: {str(e)}'})
        
        finally:
            cursor.close()
            conn.close()
    return JsonResponse({'status': 'fail', 'message': 'Ph∆∞∆°ng th·ª©c kh√¥ng h·ª£p l·ªá'})

@csrf_exempt
@login_required(login_url="login")
def delete_student_from_class(request):
    if request.method == "POST":
        mssv = request.POST.get('mssv')
        lophp = request.POST.get('lophp')

        if not mssv or not lophp:
            return JsonResponse({'status': 'fail', 'message': 'Thi·∫øu MSSV ho·∫∑c l·ªõp h·ªçc ph·∫ßn'})

        conn = connect_to_db()
        cursor = conn.cursor()

        try:
            cursor.execute("DELETE FROM dkmh WHERE mssv = ? AND lophp = ?", (mssv, lophp))
            if cursor.rowcount == 0:
                return JsonResponse({'status': 'fail', 'message': 'Kh√¥ng t√¨m th·∫•y sinh vi√™n trong l·ªõp h·ªçc ph·∫ßn'})
            conn.commit()
            return JsonResponse({'status': 'success', 'message': 'X√≥a sinh vi√™n th√†nh c√¥ng'})

        except Exception as e:
            return JsonResponse({'status': 'fail', 'message': f'L·ªói: {str(e)}'})
        
        finally:
            cursor.close()
            conn.close()
    return JsonResponse({'status': 'fail', 'message': 'Ph∆∞∆°ng th·ª©c kh√¥ng h·ª£p l·ªá'})

@csrf_exempt
@login_required(login_url="login")
def import_students_to_class_excel(request):
    if request.method != "POST" or not request.FILES.get('file') or not request.POST.get('lophp'):
        return JsonResponse({'status': 'fail', 'message': 'Thi·∫øu l·ªõp h·ªçc ph·∫ßn ho·∫∑c file Excel'})

    lophp = request.POST.get('lophp').strip()
    excel_file = request.FILES['file']
    if not excel_file.name.endswith('.xlsx'):
        return JsonResponse({'status': 'fail', 'message': 'File ph·∫£i c√≥ ƒë·ªãnh d·∫°ng .xlsx'})

    temp_file = tempfile.NamedTemporaryFile(delete=False, suffix='.xlsx')
    temp_file_path = temp_file.name
    
    try:
        with open(temp_file_path, 'wb') as f:
            for chunk in excel_file.chunks():
                f.write(chunk)
        
        wb = openpyxl.load_workbook(temp_file_path)
        sheet = wb.active
        if not sheet:
            raise ValueError("File Excel kh√¥ng ch·ª©a worksheet n√†o")
        
        conn = connect_to_db()
        cursor = conn.cursor()
        
        rows_added = 0
        errors = []
        expected_headers = ['MSSV']
        
        headers = [cell.value for cell in sheet[1]]
        if not all(h in headers for h in expected_headers):
            raise ValueError("File Excel kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng. C·∫ßn c·ªôt: MSSV")
        
        for row_idx, row in enumerate(sheet.iter_rows(min_row=2, values_only=True), start=2):
            if not row or len(row) < 1:
                errors.append(f"D√≤ng {row_idx}: Thi·∫øu d·ªØ li·ªáu")
                continue
            
            mssv = str(row[0]).strip() if row[0] else None
            if not mssv:
                errors.append(f"D√≤ng {row_idx}: MSSV kh√¥ng h·ª£p l·ªá")
                continue
                
            cursor.execute("SELECT COUNT(*) FROM thongtin WHERE mssv = ?", (mssv,))
            if cursor.fetchone()[0] == 0:
                errors.append(f"D√≤ng {row_idx}: MSSV {mssv} kh√¥ng t·ªìn t·∫°i trong h·ªá th·ªëng")
                continue
                
            cursor.execute("SELECT COUNT(*) FROM dkmh WHERE mssv = ? AND lophp = ?", (mssv, lophp))
            if cursor.fetchone()[0] > 0:
                errors.append(f"D√≤ng {row_idx}: MSSV {mssv} ƒë√£ c√≥ trong l·ªõp {lophp}")
                continue
                
            cursor.execute("INSERT INTO dkmh (mssv, lophp) VALUES (?, ?)", (mssv, lophp))
            rows_added += 1
        
        if rows_added == 0:
            raise ValueError("Kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá n√†o ƒë∆∞·ª£c th√™m")
        
        conn.commit()
        message = f"Nh·∫≠p danh s√°ch sinh vi√™n th√†nh c√¥ng, ƒë√£ th√™m {rows_added} sinh vi√™n v√†o l·ªõp {lophp}"
        if errors:
            message += f". C√≥ {len(errors)} l·ªói: {', '.join(errors[:5])}"
        
        return JsonResponse({'status': 'success', 'message': message})
    
    except Exception as e:
        print(f"L·ªói khi nh·∫≠p Excel: {e}")
        return JsonResponse({'status': 'fail', 'message': f'L·ªói: {str(e)}'})
    
    finally:
        cursor.close()
        conn.close()
        try:
            if os.path.exists(temp_file_path):
                os.unlink(temp_file_path)
        except Exception as e:
            print(f"Kh√¥ng th·ªÉ x√≥a file t·∫°m: {e}")

@login_required(login_url="login")
def export_students_by_class(request):
    conn = connect_to_db()
    cursor = conn.cursor()

    lophp = request.GET.get('lophp')
    if not lophp:
        return HttpResponse("Vui l√≤ng cung c·∫•p l·ªõp h·ªçc ph·∫ßn tr∆∞·ªõc khi xu·∫•t Excel", status=400)

    try:
        cursor.execute("""
            SELECT thongtin.mssv, thongtin.name, thongtin.lop 
            FROM thongtin 
            INNER JOIN dkmh ON dkmh.mssv = thongtin.mssv 
            WHERE dkmh.lophp = ?
            ORDER BY CAST(SUBSTR(thongtin.mssv, 2) AS INTEGER) ASC
        """, (lophp,))
        data = cursor.fetchall()

        response = HttpResponse(content_type='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')
        response['Content-Disposition'] = f'attachment; filename="danhsach_{lophp}_{datetime.now().strftime("%Y%m%d_%H%M%S")}.xlsx"'

        wb = openpyxl.Workbook()
        ws = wb.active
        ws.title = f'Danh S√°ch {lophp}'

        columns = ['MSSV', 'H·ªç T√™n', 'L·ªõp']
        ws.append(columns)

        for cell in ws[1]:
            cell.font = openpyxl.styles.Font(bold=True)
            cell.alignment = openpyxl.styles.Alignment(horizontal='center')
            cell.border = openpyxl.styles.Border(
                left=openpyxl.styles.Side(style='thin'),
                right=openpyxl.styles.Side(style='thin'),
                top=openpyxl.styles.Side(style='thin'),
                bottom=openpyxl.styles.Side(style='thin')
            )

        for row in data:
            ws.append([str(value) for value in row])

        for row in ws.iter_rows(min_row=2, max_row=ws.max_row):
            for cell in row:
                cell.border = openpyxl.styles.Border(
                    left=openpyxl.styles.Side(style='thin'),
                    right=openpyxl.styles.Side(style='thin'),
                    top=openpyxl.styles.Side(style='thin'),
                    bottom=openpyxl.styles.Side(style='thin')
                )

        for col in ws.columns:
            max_length = 0
            column = col[0].column_letter
            for cell in col:
                try:
                    if len(str(cell.value)) > max_length:
                        max_length = len(str(cell.value))
                except:
                    pass
            adjusted_width = (max_length + 2)
            ws.column_dimensions[column].width = adjusted_width

        wb.save(response)
        return response

    except Exception as e:
        print(f"L·ªói khi xu·∫•t Excel: {e}")
        return HttpResponse(f"L·ªói: {str(e)}", status=500)

    finally:
        cursor.close()
        conn.close()
@csrf_exempt
@login_required(login_url="login")
def import_excel(request):
    if request.method != "POST" or not request.FILES.get('file'):
        return JsonResponse({'status': 'error', 'message': 'Kh√¥ng c√≥ file ho·∫∑c ph∆∞∆°ng th·ª©c kh√¥ng h·ª£p l·ªá'})

    excel_file = request.FILES['file']
    if not excel_file.name.endswith(('.xlsx', '.xls')):
        return JsonResponse({'status': 'error', 'message': 'File ph·∫£i c√≥ ƒë·ªãnh d·∫°ng .xlsx ho·∫∑c .xls'})

    temp_file = tempfile.NamedTemporaryFile(delete=False, suffix='.xls' if excel_file.name.endswith('.xls') else '.xlsx')
    temp_file_path = temp_file.name
    
    conn = None
    cursor = None
    magv = str(request.user.id)
    print(magv)
    try:
        with open(temp_file_path, 'wb') as f:
            for chunk in excel_file.chunks():
                f.write(chunk)
        
        # X·ª≠ l√Ω file d·ª±a tr√™n ƒë·ªãnh d·∫°ng
        if excel_file.name.endswith('.xls'):
            import xlrd
            wb = xlrd.open_workbook(temp_file_path)
            sheet = wb.sheet_by_index(0)
            
            def get_cell_value(row_idx, col_idx):
                try:
                    return sheet.cell_value(row_idx - 1, col_idx - 1)
                except IndexError:
                    return None
            
            lophp = get_cell_value(8, 6)
            if not lophp or "M√£ m√¥n h·ªçc/M√£ nh√≥m:" not in lophp:
                raise ValueError("Kh√¥ng t√¨m th·∫•y m√£ l·ªõp h·ªçc ph·∫ßn trong file Excel")
            lophp = lophp.split(":")[1].strip()
            lophp = lophp.replace("/", "-")

            headers = [get_cell_value(12, col) for col in range(1, sheet.ncols + 1)]
            date_columns = headers[11:]

            def iter_rows(min_row):
                for row_idx in range(min_row, sheet.nrows + 1):
                    yield [get_cell_value(row_idx, col) for col in range(1, sheet.ncols + 1)]
        
        elif excel_file.name.endswith('.xlsx'):
            from openpyxl import load_workbook
            wb = load_workbook(temp_file_path)
            sheet = wb.active
            if not sheet:
                raise ValueError("File Excel kh√¥ng ch·ª©a worksheet n√†o")
            
            lophp = sheet['F8'].value
            if not lophp or "M√£ m√¥n h·ªçc/M√£ nh√≥m:" not in lophp:
                raise ValueError("Kh√¥ng t√¨m th·∫•y m√£ l·ªõp h·ªçc ph·∫ßn trong file Excel")
            lophp = lophp.split(":")[1].strip()

            headers = [cell.value for cell in sheet[12]]
            date_columns = headers[12:]

            def iter_rows(min_row):
                return sheet.iter_rows(min_row=min_row, values_only=True)

        conn = connect_to_db()
        cursor = conn.cursor()
        
        
        lich_success = []
        lich_failed = []
        sv_success = []
        sv_failed = []
        dd_success = 0
        
        lich_dict = {}
        for idx, date in enumerate(date_columns, start=1):
            if not date:
                continue
            try:
                date_obj = datetime.strptime(date, '%d/%m/%Y')
                date_str = date_obj.strftime('%Y-%m-%d')
            except ValueError:
                lich_failed.append(f"Ng√†y {date}: ƒê·ªãnh d·∫°ng kh√¥ng h·ª£p l·ªá")
                continue

            cursor.execute(
                "SELECT malich FROM lich WHERE lophp = ? AND tiet = ? AND ngay = ? AND magv = ?",
                (lophp, "1", date_str, magv)
            )
            existing_lich = cursor.fetchone()
            if existing_lich:
                lich_dict[date] = existing_lich[0]
                lich_failed.append(f"Ng√†y {date}: ƒê√£ t·ªìn t·∫°i")
            else:
                cursor.execute(
                    "INSERT INTO lich (lophp, tiet, ngay, magv) VALUES (?, ?, ?, ?)",
                    (lophp, "1", date_str, magv)
                )
                cursor.execute("SELECT last_insert_rowid()")
                malich = cursor.fetchone()[0]
                lich_dict[date] = malich
                lich_success.append(f"Ng√†y {date}")

        # B∆∞·ªõc 2: Import danh s√°ch sinh vi√™n (b·∫£ng dkmh)
        for row_idx, row in enumerate(iter_rows(min_row=13), start=13):
            if not row or len(row) < 2:
                sv_failed.append(f"D√≤ng {row_idx}: Thi·∫øu d·ªØ li·ªáu")
                continue

            mssv = str(row[1]).strip() if row[1] else None
            if not mssv:
                sv_failed.append(f"D√≤ng {row_idx}: MSSV kh√¥ng h·ª£p l·ªá")
                continue

            cursor.execute("SELECT COUNT(*) FROM thongtin WHERE mssv = ?", (mssv,))
            if cursor.fetchone()[0] == 0:
                sv_failed.append(f"MSSV {mssv}: Kh√¥ng t·ªìn t·∫°i trong h·ªá th·ªëng")
                continue

            cursor.execute(
                "SELECT COUNT(*) FROM dkmh WHERE lophp = ? AND mssv = ?",
                (lophp, mssv)
            )
            if cursor.fetchone()[0] > 0:
                sv_failed.append(f"MSSV {mssv}: ƒê√£ t·ªìn t·∫°i trong l·ªõp {lophp}")
                continue

            cursor.execute(
                "INSERT INTO dkmh (lophp, mssv) VALUES (?, ?)",
                (lophp, mssv)
            )
            sv_success.append(f"MSSV {mssv}")

        # B∆∞·ªõc 3: Import ƒëi·ªÉm danh (b·∫£ng diemdanh)
        for row_idx, row in enumerate(iter_rows(min_row=13), start=13):
            if not row or len(row) < 2:
                continue

            mssv = str(row[1]).strip() if row[1] else None
            if not mssv:
                continue

            for col_idx, date in enumerate(date_columns, start=9):
                status = row[col_idx]
                if status == '‚úì':
                    date_str = datetime.strptime(date, '%d/%m/%Y').strftime('%Y-%m-%d')
                    if date in lich_dict:
                        malich = lich_dict[date]
                        cursor.execute(
                            "SELECT COUNT(*) FROM diemdanh WHERE mssv = ? AND malich = ?",
                            (mssv, malich)
                        )
                        if cursor.fetchone()[0] == 0:
                            current_time = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
                            cursor.execute(
                                "INSERT INTO diemdanh (mssv, time, malich) VALUES (?, ?, ?)",
                                (mssv, current_time, malich)
                            )
                            dd_success += 1

        conn.commit()
        
        message = f"Nh·∫≠p Excel th√†nh c√¥ng:\n"
        message += f"- Th√™m {len(lich_success)} l·ªãch h·ªçc th√†nh c√¥ng: {', '.join(lich_success[:5]) if lich_success else 'Kh√¥ng c√≥'}\n"
        message += f"- Th√™m {len(sv_success)} sinh vi√™n th√†nh c√¥ng: {', '.join(sv_success[:5]) if sv_success else 'Kh√¥ng c√≥'}\n"
        message += f"- Th√™m {dd_success} b·∫£n ghi ƒëi·ªÉm danh\n"
        if lich_failed or sv_failed:
            message += "C√°c th·∫•t b·∫°i:\n"
            if lich_failed:
                message += f"- L·ªãch th·∫•t b·∫°i ({len(lich_failed)}): {', '.join(lich_failed[:5])}\n"
            if sv_failed:
                message += f"- Sinh vi√™n th·∫•t b·∫°i ({len(sv_failed)}): {', '.join(sv_failed[:5])}"
        
        return JsonResponse({'status': 'success', 'message': message})
    
    except Exception as e:
        print(f"L·ªói khi nh·∫≠p Excel: {e}")
        return JsonResponse({'status': 'error', 'message': f'L·ªói: {str(e)}'})
    
    finally:
        if cursor is not None:
            cursor.close()
        if conn is not None:
            conn.close()
        try:
            if os.path.exists(temp_file_path):
                os.unlink(temp_file_path)
        except Exception as e:
            print(f"Kh√¥ng th·ªÉ x√≥a file t·∫°m: {e}")

@login_required(login_url="login")
def export_excel(request):
    start_date = request.GET.get('start_date', datetime.now().strftime('%Y-%m-%d'))
    
    try:
        start = datetime.strptime(start_date, '%Y-%m-%d')
        end = start + timedelta(days=6)
        
        conn = connect_to_db()
        cursor = conn.cursor()
        cursor.execute(
            "SELECT malich, lophp, tiet, ngay FROM lich WHERE ngay BETWEEN ? AND ? ORDER BY ngay, lophp, tiet",
            (start.strftime('%Y-%m-%d'), end.strftime('%Y-%m-%d'))
        )
        lich_list = cursor.fetchall()
        
        response = HttpResponse(content_type='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')
        response['Content-Disposition'] = f'attachment; filename="lich_phong_{start.strftime("%Y%m%d")}_to_{end.strftime("%Y%m%d")}.xlsx"'
        
        wb = openpyxl.Workbook()
        ws = wb.active
        ws.title = 'L·ªãch Ph√≤ng'
        
        columns = ['maLich', 'maLop', 'tiet', 'ngay']
        ws.append(columns)
        
        for cell in ws[1]:
            cell.font = openpyxl.styles.Font(bold=True)
            cell.alignment = openpyxl.styles.Alignment(horizontal='center')
            cell.border = openpyxl.styles.Border(
                left=openpyxl.styles.Side(style='thin'),
                right=openpyxl.styles.Side(style='thin'),
                top=openpyxl.styles.Side(style='thin'),
                bottom=openpyxl.styles.Side(style='thin')
            )
        
        for row in lich_list:
            ws.append([str(value) for value in row])
        
        for row in ws.iter_rows(min_row=2, max_row=ws.max_row):
            for cell in row:
                cell.border = openpyxl.styles.Border(
                    left=openpyxl.styles.Side(style='thin'),
                    right=openpyxl.styles.Side(style='thin'),
                    top=openpyxl.styles.Side(style='thin'),
                    bottom=openpyxl.styles.Side(style='thin')
                )
        
        for col in ws.columns:
            max_length = max(len(str(cell.value or '')) for cell in col) + 2
            ws.column_dimensions[col[0].column_letter].width = max_length
        
        wb.save(response)
        return response
    
    except Exception as e:
        print(f"L·ªói khi xu·∫•t Excel: {e}")
        return HttpResponse(f"L·ªói: {str(e)}", status=500)
    
    finally:
        cursor.close()
        conn.close()

@login_required(login_url="login")
def import_students_excel(request):
    if request.method != "POST" or not request.FILES.get('file'):
        return JsonResponse({'status': 'error', 'message': 'Kh√¥ng c√≥ file ho·∫∑c ph∆∞∆°ng th·ª©c kh√¥ng h·ª£p l·ªá'})

    excel_file = request.FILES['file']
    if not excel_file.name.endswith('.xlsx'):
        return JsonResponse({'status': 'error', 'message': 'File ph·∫£i c√≥ ƒë·ªãnh d·∫°ng .xlsx'})

    temp_file = tempfile.NamedTemporaryFile(delete=False, suffix='.xlsx')
    temp_file_path = temp_file.name
    
    try:
        with open(temp_file_path, 'wb') as f:
            for chunk in excel_file.chunks():
                f.write(chunk)
        
        wb = openpyxl.load_workbook(temp_file_path)
        sheet = wb.active
        if not sheet:
            raise ValueError("File Excel kh√¥ng ch·ª©a worksheet n√†o")
        
        conn = connect_to_db()
        cursor = conn.cursor()
        
        rows_added = 0
        errors = []
        for row in sheet.iter_rows(min_row=2, values_only=True):
            if len(row) >= 3:
                mssv = str(row[0]).strip() if row[0] else None
                name = str(row[1]).strip() if row[1] else None
                lop = str(row[2]).strip() if row[2] else None
                if mssv and name and lop:
                    cursor.execute("SELECT COUNT(*) FROM thongtin WHERE mssv = ?", (mssv,))
                    if cursor.fetchone()[0] > 0:
                        errors.append(f"MSSV {mssv} ƒë√£ t·ªìn t·∫°i, b·ªè qua")
                        continue
                    
                    cursor.execute("INSERT INTO thongtin (mssv, name, lop) VALUES (?, ?, ?)", (mssv, name, lop))
                    rows_added += 1
        
        if rows_added == 0 and not errors:
            raise ValueError("Kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá trong file Excel ƒë·ªÉ th√™m")
        
        conn.commit()
        conn.close()
        wb.close()
        
        message = f"Nh·∫≠p Excel th√†nh c√¥ng, ƒë√£ th√™m {rows_added} sinh vi√™n"
        if errors:
            message += f". L·ªói: {', '.join(errors)}"
        return JsonResponse({'status': 'success', 'message': message})
    
    except Exception as e:
        print(f"L·ªói khi nh·∫≠p Excel sinh vi√™n: {str(e)}")
        return JsonResponse({'status': 'error', 'message': f'L·ªói: {str(e)}'})
    
    finally:
        try:
            if os.path.exists(temp_file_path):
                os.unlink(temp_file_path)
        except Exception as e:
            print(f"Kh√¥ng th·ªÉ x√≥a file t·∫°m: {e}")

@login_required(login_url="login")
def export_thongke_excel(request):
    lop = request.GET.get('lop', '').strip()
    if not lop:
        return HttpResponse("Vui l√≤ng ch·ªçn l·ªõp tr∆∞·ªõc khi xu·∫•t Excel", status=400)

    magv = str(request.user.id)
    try:
        conn = connect_to_db()
        cursor = conn.cursor()

        cursor.execute("""
            SELECT COUNT(*) 
            FROM lich 
            WHERE lophp = ? AND magv = ?
        """, (lop, magv))
        if cursor.fetchone()[0] == 0:
            conn.close()
            return HttpResponse("B·∫°n kh√¥ng c√≥ quy·ªÅn xu·∫•t th·ªëng k√™ cho l·ªõp n√†y", status=403)

        cursor.execute("""
            SELECT malich, ngay, tiet 
            FROM lich 
            WHERE lophp = ? AND magv = ? 
            ORDER BY ngay, tiet
        """, (lop, magv))
        lich_rows = cursor.fetchall()

        headers = ['STT', 'MSSV', 'H·ªç T√™n']
        lich_dict = {}
        for malich, ngay, tiet in lich_rows:
            headers.append(f"Ti·∫øt {tiet} Ng√†y {ngay}")
            lich_dict[str(malich)] = (ngay, tiet)

        cursor.execute("""
            SELECT DISTINCT thongtin.mssv, thongtin.name 
            FROM thongtin 
            INNER JOIN dkmh ON thongtin.mssv = dkmh.mssv 
            WHERE dkmh.lophp = ?
        """, (lop,))
        sv_rows = cursor.fetchall()

        sv_rows_sorted = sorted(sv_rows, key=lambda x: vietnamese_last_word_sort_key(x[1]))

        data = []
        for idx, (mssv, name) in enumerate(sv_rows_sorted, start=1):
            row_data = [idx, mssv, name]
            cursor.execute("""
                SELECT malich 
                FROM diemdanh 
                WHERE mssv = ?
            """, (mssv,))
            diemdanh_rows = cursor.fetchall()
            diemdanh_malich = set(row[0] for row in diemdanh_rows if row[0] is not None)

            for malich, (ngay, tiet) in lich_dict.items():
                row_data.append('‚úì' if malich in diemdanh_malich else '')
            data.append(row_data)

        response = HttpResponse(content_type='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')
        response['Content-Disposition'] = f'attachment; filename="thongke_diemdanh_{lop}_{datetime.now().strftime("%Y%m%d_%H%M%S")}.xlsx"'

        wb = openpyxl.Workbook()
        ws = wb.active
        ws.title = f'Th·ªëng K√™ ƒêi·ªÉm Danh {lop}'

        ws.append(headers)
        for cell in ws[1]:
            cell.font = openpyxl.styles.Font(bold=True)
            cell.alignment = openpyxl.styles.Alignment(horizontal='center')
            cell.border = openpyxl.styles.Border(
                left=openpyxl.styles.Side(style='thin'),
                right=openpyxl.styles.Side(style='thin'),
                top=openpyxl.styles.Side(style='thin'),
                bottom=openpyxl.styles.Side(style='thin')
            )

        for row in data:
            ws.append(row)

        for row in ws.iter_rows(min_row=2, max_row=ws.max_row):
            for cell in row:
                cell.border = openpyxl.styles.Border(
                    left=openpyxl.styles.Side(style='thin'),
                    right=openpyxl.styles.Side(style='thin'),
                    top=openpyxl.styles.Side(style='thin'),
                    bottom=openpyxl.styles.Side(style='thin')
                )
                if cell.value == '‚úì':
                    cell.font = openpyxl.styles.Font(color='00FF00')
                    cell.alignment = openpyxl.styles.Alignment(horizontal='center')

        for col in ws.columns:
            max_length = max(len(str(cell.value or '')) for cell in col) + 2
            ws.column_dimensions[col[0].column_letter].width = max_length

        wb.save(response)
        conn.close()
        return response

    except Exception as e:
        print(f"L·ªói trong export_thongke_excel: {e}")
        return HttpResponse(f"L·ªói: {str(e)}", status=500)

@login_required(login_url="login")
def thongke_chi_tiet(request):
    conn = connect_to_db()
    cursor = conn.cursor()
    if not is_superuser_sql(request.user.id):
        conn.close()
        return JsonResponse({'error': 'Kh√¥ng ƒë·ªß quy·ªÅn ƒë·ªÉ truy c·∫≠p!'}, status=403)
    lop = request.GET.get('lop', None)
    magv = str(request.user.id)

    try:
        cursor.execute("""
            SELECT DISTINCT lophp 
            FROM lich 
            WHERE magv = ? 
            ORDER BY lophp
        """, (magv,))
        lop_list = [row[0] for row in cursor.fetchall()]
        print(f"DEBUG: Danh s√°ch l·ªõp cho magv {magv}: {lop_list}")

        if not lop:
            return JsonResponse({
                'lop_list': lop_list,
                'tiet_ngay_stats': {'headers': [], 'data': []}
            })

        cursor.execute("""
            SELECT COUNT(*) 
            FROM lich 
            WHERE lophp = ? AND magv = ?
        """, (lop, magv))
        if cursor.fetchone()[0] == 0:
            return JsonResponse({
                'lop_list': lop_list,
                'tiet_ngay_stats': {'headers': [], 'data': []},
                'error': 'B·∫°n kh√¥ng c√≥ quy·ªÅn xem th·ªëng k√™ l·ªõp n√†y'
            })

        cursor.execute("""
            SELECT malich, ngay, tiet 
            FROM lich 
            WHERE lophp = ? AND magv = ? 
            ORDER BY ngay, tiet
        """, (lop, magv))
        lich_rows = cursor.fetchall()
        
        headers = ['STT', 'MSSV', 'H·ªç T√™n']
        lich_dict = {}
        for malich, ngay, tiet in lich_rows:
            headers.append(f"Ti·∫øt {tiet} Ng√†y {ngay}")
            lich_dict[str(malich)] = (ngay, tiet)

        cursor.execute("""
            SELECT DISTINCT thongtin.mssv, thongtin.name 
            FROM thongtin 
            INNER JOIN dkmh ON thongtin.mssv = dkmh.mssv 
            WHERE dkmh.lophp = ?
        """, (lop,))
        sv_rows = cursor.fetchall()

        # S·∫Øp x·∫øp theo t√™n ti·∫øng Vi·ªát
        sv_rows_sorted = sorted(sv_rows, key=lambda x: vietnamese_last_word_sort_key(x[1]))

        data = []
        for idx, (mssv, name) in enumerate(sv_rows_sorted, start=1):
            row_data = {'stt': idx, 'mssv': mssv, 'name': name}
            cursor.execute("""
                SELECT malich 
                FROM diemdanh 
                WHERE mssv = ?
            """, (mssv,))
            diemdanh_rows = cursor.fetchall()
            diemdanh_malich = set(row[0] for row in diemdanh_rows if row[0] is not None)

            for malich, (ngay, tiet) in lich_dict.items():
                row_data[f"{ngay}_{tiet}"] = 'ƒê√£ ƒëi·ªÉm danh' if malich in diemdanh_malich else ''
            
            data.append(row_data)

        conn.close()
        return JsonResponse({
            'lop_list': lop_list,
            'tiet_ngay_stats': {
                'headers': headers,
                'data': data
            }
        })

    except Exception as e:
        print(f"L·ªói trong thongke_chi_tiet: {e}")
        return JsonResponse({'error': str(e)}, status=500)

def get_random_token(request):
    random_token = ''.join(random.choices(string.ascii_letters + string.digits, k=10))
    request.session['random_token'] = random_token
    request.session.modified = True
    return JsonResponse({'random_token': random_token})


def register(request):
    if request.method == "POST":
        content_type = request.headers.get('Content-Type', '')
        if 'application/json' in content_type:
            try:
                data = json.loads(request.body)
                print("data", data)
                username = data.get('username')
                name = data.get('name')
                gmail = data.get('gmail')
                password = data.get('random_token')

                if not username or not name or not gmail or not password:
                    return JsonResponse({'success': False, 'message': 'Thi·∫øu th√¥ng tin ƒëƒÉng k√Ω!'})

                if User.objects.filter(username=username).exists():
                    return JsonResponse({'success': False, 'message': 'T√™n ƒëƒÉng nh·∫≠p ƒë√£ t·ªìn t·∫°i!'})
                elif User.objects.filter(email=gmail).exists():
                    return JsonResponse({'success': False, 'message': 'Gmail ƒë√£ t·ªìn t·∫°i!'})
                else:
                    user = User(username=username, email=gmail, last_name=name)
                    user.set_password(password)  
                    user.save()
                    return JsonResponse({'success': True, 'message': 'ƒêƒÉng k√Ω th√†nh c√¥ng! H√£y ƒëƒÉng nh·∫≠p.'})
            except json.JSONDecodeError:
                return JsonResponse({'success': False, 'message': 'D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá!'})
        else:
            return JsonResponse({'success': False, 'message': 'Y√™u c·∫ßu kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£!'})

    return render(request, "register.html")

def login_view(request):
    if request.method == "POST":
        content_type = request.headers.get('Content-Type', '')
        if 'application/json' in content_type:
            try:
                data = json.loads(request.body)
                print("data", data)
                username = data.get('username')
                combined_data = data.get('random_token')
                if not username or not combined_data:
                    return JsonResponse({'success': False, 'message': 'Thi·∫øu th√¥ng tin ƒëƒÉng nh·∫≠p!'})
            except json.JSONDecodeError:
                return JsonResponse({'success': False, 'message': 'D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá!'})
        else:
            return JsonResponse({'success': False, 'message': 'Y√™u c·∫ßu kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£!'})

        user = authenticate(request, username=username, password=combined_data)
        if user:
            current_session_key = request.session.session_key

            all_sessions = Session.objects.filter(expire_date__gte=timezone.now())
            for session in all_sessions:
                session_data = session.get_decoded()
                session_user_id = session_data.get('_auth_user_id')
                if session_user_id == str(user.id) and session.session_key != current_session_key:
                    session.delete()

            login(request, user)
            request.session["user_id"] = user.id
            request.session["username"] = user.username
            request.session["name"] = user.last_name or user.username
            request.session.modified = True

            return JsonResponse({'success': True, 'message': 'ƒêƒÉng nh·∫≠p th√†nh c√¥ng!'})
        else:
            return JsonResponse({'success': False, 'message': 'Sai t√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u!'})

    return render(request, "login.html")
 

@login_required(login_url="login")
def update_profile(request):
    if request.method == "POST":
        user = request.user
        email = request.POST.get("email")
        name = request.POST.get("name")
        password = request.POST.get("hashed_password")
        print(email, name, password)
        try:
            if email and email != user.email:
                if User.objects.filter(email=email).exclude(id=user.id).exists():
                    messages.error(request, "Email ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng!")
                    return redirect("update_profile")
                user.email = email

            if name:
                user.last_name = name

            if password:
                user.set_password(password)

            user.save()
            messages.success(request, "C·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng!")
            return redirect("update_profile")

        except Exception as e:
            messages.error(request, f"L·ªói khi c·∫≠p nh·∫≠t: {str(e)}")
            return redirect("update_profile")
    return render(request, "profile.html")

@login_required
def check_session(request):
    is_authenticated = request.user.is_authenticated
    return JsonResponse({'is_authenticated': is_authenticated})

def logout_view(request):
    logout(request)
    request.session.flush()
    Session.objects.all().delete()
    return redirect('login')

def clear_all_sessions():
    try:
        logger.info("üî• Server restart - X√≥a t·∫•t c·∫£ session!")
        Session.objects.all().delete()
    except Exception as e:
        logger.error(f"L·ªói khi x√≥a session: {str(e)}")

# Kh·ªüi t·∫°o TensorFlow v√† c√°c model
try:
    import tensorflow as tf
    tf.get_logger().setLevel('ERROR')  # Gi·∫£m log level c·ªßa TensorFlow
    
    # Kh·ªüi t·∫°o model face detection
    mp_face_detection = mp.solutions.face_detection
    face_detection = mp_face_detection.FaceDetection(
        model_selection=0, 
        min_detection_confidence=0.5
    )
    
    # Kh·ªüi t·∫°o model face recognition
    device = torch.device("cuda" if torch.cuda.is_available() else "cpu")
    model = InceptionResnetV1(pretrained='vggface2').eval().to(device)
    
    logger.info("‚úÖ ƒê√£ kh·ªüi t·∫°o c√°c model th√†nh c√¥ng")
except Exception as e:
    logger.error(f"‚ùå L·ªói khi kh·ªüi t·∫°o model: {str(e)}")

# Kh·ªüi t·∫°o c·∫£m bi·∫øn v√¢n tay
try:
    ftr_scan = initialize_dll()
    if ftr_scan:
        fingerprint_sensor = initialize_fingerprint_sensor()
        if fingerprint_sensor:
            logger.info("‚úÖ ƒê√£ kh·ªüi t·∫°o c·∫£m bi·∫øn v√¢n tay th√†nh c√¥ng")
        else:
            logger.warning("‚ö†Ô∏è Kh√¥ng th·ªÉ kh·ªüi t·∫°o c·∫£m bi·∫øn v√¢n tay")
    else:
        logger.warning("‚ö†Ô∏è Kh√¥ng th·ªÉ kh·ªüi t·∫°o DLL")
except Exception as e:
    logger.error(f"‚ùå L·ªói khi kh·ªüi t·∫°o c·∫£m bi·∫øn v√¢n tay: {str(e)}")

# X√≥a session khi kh·ªüi ƒë·ªông
clear_all_sessions()

def manual_open(request):
    if request.method == "POST":
        mssv = request.POST.get("manual_mssv")
        username = request.POST.get("username")
        password = request.POST.get("password")

        if not mssv or not username or not password:
            return JsonResponse({"error": "Thi·∫øu th√¥ng tin ƒëƒÉng nh·∫≠p ho·∫∑c MSSV!"}, status=400)

        mssv = mssv.strip()
        user = authenticate(username=username, password=password)
        if user is None:
            return JsonResponse({"error": "T√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ch√≠nh x√°c!"}, status=400)

        conn = connect_to_db()
        cursor = conn.cursor()

        cursor.execute("SELECT mssv FROM thongtin WHERE mssv = ?", (mssv,))
        sinh_vien = cursor.fetchone()

        if not sinh_vien:
            conn.close()
            return JsonResponse({"error": "MSSV kh√¥ng t·ªìn t·∫°i trong h·ªá th·ªëng!"}, status=400)

        time_now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        cursor.execute("INSERT INTO diemdanh (mssv, time) VALUES (?, ?)", (mssv, time_now))

        conn.commit()
        conn.close()

        return JsonResponse({"message": "‚úÖ ƒê√£ log th√†nh c√¥ng!"})

    return JsonResponse({"error": "Y√™u c·∫ßu kh√¥ng h·ª£p l·ªá!"}, status=400)

@csrf_exempt
@login_required(login_url="login")
def check_fingerprint_sensor(request):
    if request.method == "GET":
        try:
            sensor = get_fingerprint_sensor()
            if not sensor:
                return JsonResponse({
                    'success': False,
                    'message': 'C·∫£m bi·∫øn ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o',
                    'sensor_initialized': False
                })
            sensor_ok, sensor_message = check_sensor_status()
            return JsonResponse({
                'success': sensor_ok,
                'message': sensor_message,
                'sensor_initialized': True
            })
        except Exception as e:
            return JsonResponse({
                'success': False,
                'message': f'L·ªói ki·ªÉm tra c·∫£m bi·∫øn: {str(e)}',
                'sensor_initialized': False
            })
    return JsonResponse({'success': False, 'message': 'Ph∆∞∆°ng th·ª©c kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£!'})

print("==> ƒêang ki·ªÉm tra DLL:", DLL_PATH)
print("==> ƒê√£ load DLL th√†nh c√¥ng")
print("==> ƒê√£ m·ªü thi·∫øt b·ªã th√†nh c√¥ng")

def get_fingerprint_sensor():
    # KH√îNG d√πng bi·∫øn to√†n c·ª•c n·ªØa
    return initialize_fingerprint_sensor()

